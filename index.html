<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Notification Demo</title>
    <link rel="manifest" href="https://severside-json.github.io/webswjsnotification/manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://severside-json.github.io/webswjsnotification/icon-192x192.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button {
            background-color: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 1rem;
        }
        button:hover {
            background-color: #3570b7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PWA Notification Demo</h1>
        <p>Click the button below to subscribe to push notifications.</p>
        <button id="subscribe-button">Subscribe to Notifications</button>
        <button id="send-notification-button">Gửi Thông Báo Nâng Cao</button>
        <p id="status"></p>
    </div>

    <script>
       // main.js
let swRegistration = null;

// Đăng ký Service Worker
if ('serviceWorker' in navigator && 'PushManager' in window) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js')
            .then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
                swRegistration = registration;
                initializeUI();
            })
            .catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
    });
}

function initializeUI() {
    const subscribeButton = document.getElementById('subscribe-button');
    const sendNotificationButton = document.getElementById('send-notification-button');
    const statusElement = document.getElementById('status');

    subscribeButton.addEventListener('click', function() {
        subscribeUser();
    });

    sendNotificationButton.addEventListener('click', function() {
        sendNotification();
    });

    // Kiểm tra trạng thái đăng ký
    swRegistration.pushManager.getSubscription()
        .then(function(subscription) {
            if (subscription) {
                updateSubscriptionOnServer(subscription);
                statusElement.textContent = 'Đã đăng ký nhận thông báo';
                subscribeButton.disabled = true;
            }
        });
}

function subscribeUser() {
    const applicationServerKey = urlBase64ToUint8Array('BDOsOQfR0r5a0ykbfIfaHvFBZPDhxkwtOzSk53NMYZm3F1ifbQZfMX1lG9FXFvf8OhPuULdMjzq1mPqnZ7BfDic');
    swRegistration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: applicationServerKey
    })
    .then(function(subscription) {
        console.log('User is subscribed:', subscription);
        updateSubscriptionOnServer(subscription);
        document.getElementById('status').textContent = 'Đã đăng ký nhận thông báo';
        document.getElementById('subscribe-button').disabled = true;
        
        // Bắt đầu lên lịch gửi thông báo tự động
        scheduleAutomaticNotifications();
    })
    .catch(function(err) {
        console.log('Failed to subscribe the user: ', err);
    });
}

function updateSubscriptionOnServer(subscription) {
    // Gửi subscription đến server của bạn
    console.log('Sending subscription to server:', subscription);
}

function sendNotification() {
    // Gửi yêu cầu đến server để gửi thông báo
    fetch('https://severside-json.github.io/webswjsnotification/send-notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: 'Thông báo nâng cao',
            body: 'Đây là một thông báo nâng cao từ PWA của bạn',
            icon: 'https://severside-json.github.io/webswjsnotification/icon-192x192.png'
        }),
    })
    .then(response => response.json())
    .then(data => console.log('Notification sent:', data))
    .catch((error) => console.error('Error:', error));
}

function scheduleAutomaticNotifications() {
    // Gửi message tới Service Worker để bắt đầu lên lịch thông báo
    navigator.serviceWorker.controller.postMessage({
        action: 'scheduleNotifications'
    });
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// Kiểm tra và áp dụng cập nhật cho Service Worker
function checkForUpdate() {
    navigator.serviceWorker.getRegistration().then(function(reg) {
        reg.update();
    });
}

// Kiểm tra cập nhật mỗi 1 giờ
setInterval(checkForUpdate, 1000 * 60 * 60);

// Xử lý cập nhật Service Worker
let refreshing;
navigator.serviceWorker.addEventListener('controllerchange', function () {
    if (refreshing) return;
    refreshing = true;
    window.location.reload();
});
    </script>
</body>
</html>
