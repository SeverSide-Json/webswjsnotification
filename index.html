<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dữ liệu từ Google Sheets</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://severside-json.github.io/webswjsnotification/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PWA Notify">
    <style>
        /* Các style CSS giữ nguyên */
    </style>
</head>
<body>
    <h1>Dữ liệu từ Google Sheets</h1>
    <button id="notificationPermission">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="M11.5,22C11.64,22 11.77,22 11.9,21.96C12.55,21.82 13.09,21.38 13.34,20.78C13.44,20.54 13.5,20.27 13.5,20H9.5A2,2 0 0,0 11.5,22M18,10.5C18,7.43 15.86,4.86 13,4.18V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V4.18C7.13,4.86 5,7.43 5,10.5V16L3,18V19H20V18L18,16M19.97,10H21.97C21.82,6.79 20.24,3.97 17.85,2.15L16.42,3.58C18.46,5 19.82,7.35 19.97,10M6.58,3.58L5.15,2.15C2.76,3.97 1.18,6.79 1,10H3C3.18,7.35 4.54,5 6.58,3.58Z"></path>
        </svg>
        Đồng ý nhận thông báo
    </button>
    <table id="dataTable">
        <thead>
            <tr>
                <th>Email</th>
                <th>Amount</th>
                <th>Time</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dữ liệu sẽ được thêm vào đây -->
        </tbody>
    </table>

    <script>
        const VAPID_PUBLIC_KEY = 'BB9wlVPnErCwl5r1OA-H2TiGOBhjpgQiOOfGSbeHq0RYT1Z88AjrAxZJ-sQYccv63dcK3NT-H70xFV0bVBaJOCA';

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Worker đã được đăng ký thành công:', registration);
                })
                .catch((error) => {
                    console.log('Đăng ký Service Worker thất bại:', error);
                });
        }

        const notificationButton = document.getElementById('notificationPermission');

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function subscribeUserToPush() {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
            
            console.log('User is subscribed:', subscription);
            
            // Ở đây bạn sẽ gửi subscription object lên server của bạn
            // await fetch('/api/save-subscription', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(subscription)
            // });
        }

        notificationButton.addEventListener('click', async () => {
            if (Notification.permission === 'granted') {
                console.log('Notification permission already granted');
                await subscribeUserToPush();
            } else {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    await subscribeUserToPush();
                }
            }
            updateButtonState(Notification.permission);
        });

        function updateButtonState(state) {
            if (state === 'granted') {
                notificationButton.textContent = 'Đã đồng ý nhận thông báo';
                notificationButton.disabled = true;
            }
        }

        // Kiểm tra trạng thái quyền thông báo khi tải trang
        if ('Notification' in window) {
            updateButtonState(Notification.permission);
        }

        function displayData(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            tableBody.innerHTML = '';
            data.forEach((row) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'NEW_DATA') {
                displayData(event.data.data);
            }
        });
    </script>
</body>
</html>
