<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My PWA Notification App</title>
    <link rel="manifest" href="https://severside-json.github.io/webswjsnotification/manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://severside-json.github.io/webswjsnotification/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PWA Notify">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4A90E2;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4A90E2;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PWA Notification Demo</h1>
        <p>Click the button below to subscribe to push notifications and fetch Google Sheets data.</p>
        <button id="subscribeButton">Subscribe to Notifications</button>
        <button id="advancedNotificationButton">Gửi Thông Báo Nâng Cao</button>

        <!-- Table to display Google Sheets data -->
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Amount</th>
                    <th>Time</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be appended here -->
            </tbody>
        </table>
    </div>

    <script>
    const publicVapidKey = 'BB9wlVPnErCwl5r1OA-H2TiGOBhjpgQiOOfGSbeHq0RYT1Z88AjrAxZJ-sQYccv63dcK3NT-H70xFV0bVBaJOCA';

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    async function subscribeToPushNotifications() {
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            try {
                const registration = await navigator.serviceWorker.register('./sw.js');
                console.log('Service Worker registered successfully:', registration);

                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                });

                console.log('Push Notification Subscription:', subscription);
                
                // Bắt đầu lấy dữ liệu Google Sheets và hiển thị trong HTML
                const sheetData = await fetchDataFromGoogleSheet();
                if (sheetData) {
                    displaySheetData(sheetData);
                    sendApprovalNotification();  // Gửi thông báo
                }

                alert('Đăng ký nhận thông báo thành công!');
            } catch (error) {
                console.error('Error:', error);
                alert('Đăng ký nhận thông báo thất bại. Vui lòng thử lại.');
            }
        } else {
            alert('Push notifications are not supported in your browser.');
        }
    }

    async function fetchDataFromGoogleSheet() {
        const spreadsheetId = '1Zebh-8FerNoGurfyqQP-pcSFFT_CXAcnh1I-GFHpv_c';
        const range = 'Sheet3!B2:E'; // Chỉnh lại cho đúng với Google Sheets của bạn
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=AIzaSyDqRZQ5Ms9oosYxJk_2kVSM7Hj_ObcQdoU`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            console.log('Dữ liệu từ Google Sheets:', data);
            return data.values;
        } catch (error) {
            console.error('Lỗi khi lấy dữ liệu từ Google Sheets:', error);
        }
    }

    function displaySheetData(sheetData) {
        const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        dataTable.innerHTML = ''; // Xóa dữ liệu cũ

        sheetData.forEach(row => {
            const newRow = dataTable.insertRow();
            row.forEach(cellData => {
                const newCell = newRow.insertCell();
                newCell.textContent = cellData;
            });
        });
    }

    function sendApprovalNotification() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(function(registration) {
                registration.showNotification('Phê duyệt người dùng', {
                    body: 'Có người dùng mới cần phê duyệt.',
                    icon: './icon-192x192.png',
                    badge: './icon-192x192.png',
                });
            });
        }
    }

    async function sendAdvancedNotification() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.ready;
                await registration.showNotification('Thông báo Quan trọng', {
                    body: 'Đây là nội dung thông báo quan trọng.',
                    icon: './icon-192x192.png',
                    badge: './icon-192x192.png',
                    vibrate: [100, 50, 100],
                    actions: [
                        { action: 'view', title: 'Xem Chi Tiết' },
                        { action: 'close', title: 'Đóng' }
                    ]
                });
                console.log('Advanced notification sent');
            } catch (error) {
                console.error('Error sending advanced notification:', error);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const subscribeButton = document.getElementById('subscribeButton');
        const advancedNotificationButton = document.getElementById('advancedNotificationButton');

        if (subscribeButton) {
            subscribeButton.addEventListener('click', subscribeToPushNotifications);
        }

        if (advancedNotificationButton) {
            advancedNotificationButton.addEventListener('click', sendAdvancedNotification);
        }
    });
    </script>
</body>
</html>
