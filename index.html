<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dữ liệu từ Google Sheets</title>
    <link rel="manifest" href="https://severside-json.github.io/webswjsnotification/manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://severside-json.github.io/webswjsnotification/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PWA Notify">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            padding-bottom: 80px; /* Tạo khoảng trống cho nút */
            background-color: #f0f0f0;
        }
        h1 {
            color: #333;
        }
        #notificationPermission {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: background-color 0.3s, transform 0.1s;
            z-index: 1000;
        }
        #notificationPermission:hover {
            background-color: #45a049;
        }
        #notificationPermission:active {
            transform: scale(0.98);
        }
        #notificationPermission svg {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            fill: currentColor;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>Dữ liệu từ Google Sheets</h1>
    <table id="dataTable">
        <thead>
            <tr>
                <th>Email</th>
                <th>Amount</th>
                <th>Time</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dữ liệu sẽ được thêm vào đây -->
        </tbody>
    </table>
    
    <button id="notificationPermission">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="M11.5,22C11.64,22 11.77,22 11.9,21.96C12.55,21.82 13.09,21.38 13.34,20.78C13.44,20.54 13.5,20.27 13.5,20H9.5A2,2 0 0,0 11.5,22M18,10.5C18,7.43 15.86,4.86 13,4.18V3.5A1.5,1.5 0 0,0 11.5,2A1.5,1.5 0 0,0 10,3.5V4.18C7.13,4.86 5,7.43 5,10.5V16L3,18V19H20V18L18,16M19.97,10H21.97C21.82,6.79 20.24,3.97 17.85,2.15L16.42,3.58C18.46,5 19.82,7.35 19.97,10M6.58,3.58L5.15,2.15C2.76,3.97 1.18,6.79 1,10H3C3.18,7.35 4.54,5 6.58,3.58Z"></path>
        </svg>
        Đồng ý nhận thông báo
    </button>

 <script>
        const SHEET_ID = '1Zebh-8FerNoGurfyqQP-pcSFFT_CXAcnh1I-GFHpv_c';
        const SHEET_RANGE = 'B2:E';
        const FULL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Sheet3&range=${SHEET_RANGE}`;
        const VAPID_PUBLIC_KEY = 'BB9wlVPnErCwl5r1OA-H2TiGOBhjpgQiOOfGSbeHq0RYT1Z88AjrAxZJ-sQYccv63dcK3NT-H70xFV0bVBaJOCA';
        const MIN_POLLING_INTERVAL = 1000; // 1 giây

        let swRegistration = null;
        let lastFetchTime = 0;
        let lastEtag = null;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Worker đã được đăng ký thành công:', registration);
                    swRegistration = registration;
                })
                .catch((error) => {
                    console.log('Đăng ký Service Worker thất bại:', error);
                });
        }

                async function fetchSheetData() {
            try {
                const response = await fetch(FULL_URL, {
                    headers: lastEtag ? { 'If-None-Match': lastEtag } : {}
                });

                if (response.status === 304) {
                    // Dữ liệu không thay đổi
                    return false;
                }

                lastEtag = response.headers.get('ETag');
                const text = await response.text();
                const jsonData = JSON.parse(text.substr(47).slice(0, -2));
                const sheetData = jsonData.table.rows.map(row => 
                    row.c.map(cell => cell ? cell.v : '')
                );
                
                displayData(sheetData);
                saveDataToStorage(sheetData);
                return true; // Dữ liệu đã thay đổi
            } catch (error) {
                console.error('Error fetching data:', error);
                return false;
            }
        }


        function hasDataChanged(newData) {
            const oldData = JSON.parse(localStorage.getItem('sheetData') || '[]');
            return JSON.stringify(newData) !== JSON.stringify(oldData);
        }

         function displayData(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            const fragment = document.createDocumentFragment();
            data.forEach((row) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                `;
                fragment.appendChild(tr);
            });
            tableBody.innerHTML = '';
            tableBody.appendChild(fragment);
        }

        function saveDataToStorage(data) {
            localStorage.setItem('sheetData', JSON.stringify(data));
        }

        function loadDataFromStorage() {
            const storedData = localStorage.getItem('sheetData');
            if (storedData) {
                displayData(JSON.parse(storedData));
            }
        }

        async function longPolling() {
            const currentTime = Date.now();
            const timeSinceLastFetch = currentTime - lastFetchTime;

            if (timeSinceLastFetch >= MIN_POLLING_INTERVAL) {
                lastFetchTime = currentTime;
                const dataChanged = await fetchSheetData();
                if (dataChanged) {
                    // Dữ liệu đã thay đổi, fetch ngay lập tức
                    requestAnimationFrame(longPolling);
                } else {
                    // Dữ liệu không thay đổi, đợi khoảng thời gian tối thiểu
                    setTimeout(longPolling, MIN_POLLING_INTERVAL);
                }
            } else {
                // Chưa đủ thời gian, đợi cho đến khi đủ khoảng thời gian tối thiểu
                setTimeout(longPolling, MIN_POLLING_INTERVAL - timeSinceLastFetch);
            }
        }

        document.getElementById('notificationPermission').addEventListener('click', () => {
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    subscribeToPush();
                }
            });
        });

        function subscribeToPush() {
            if (swRegistration) {
                swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                })
                .then((subscription) => {
                    console.log('User is subscribed:', subscription);
                    // Gửi subscription lên server của bạn
                })
                .catch((err) => {
                    console.log('Failed to subscribe the user: ', err);
                });
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Khởi động ứng dụng
        loadDataFromStorage();
        longPolling();
    </script>
</body>
</html>
