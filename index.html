<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My PWA Notification App</title>
    <link rel="manifest" href="https://severside-json.github.io/webswjsnotification/manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://severside-json.github.io/webswjsnotification/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PWA Notify">
    <style>
        /* Styles remain the same */
    </style>
</head>
<body>
    <div class="container">
        <h1>PWA Notification Demo</h1>
        <p>Click the button below to subscribe to push notifications.</p>
        <button id="subscribeButton">Subscribe to Notifications</button>
    </div>

    <script>
        const API_KEY = 'AIzaSyDqRZQ5Ms9oosYxJk_2kVSM7Hj_ObcQdoU';
        const SPREADSHEET_ID = '1Zebh-8FerNoGurfyqQP-pcSFFT_CXAcnh1I-GFHpv_c';
        const publicVapidKey = 'BB9wlVPnErCwl5r1OA-H2TiGOBhjpgQiOOfGSbeHq0RYT1Z88AjrAxZJ-sQYccv63dcK3NT-H70xFV0bVBaJOCA';
        const RANGE = 'Sheet3!A2:I';

        let lastRowCount = 0;

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function subscribeToPushNotifications() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Worker registered successfully:', registration);

                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                    });

                    console.log('Push Notification Subscription:', subscription);
                    
                    alert('Đăng ký nhận thông báo thành công!');
                    startCheckingForNewData();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Đăng ký nhận thông báo thất bại. Vui lòng thử lại.');
                }
            } else {
                alert('Push notifications are not supported in your browser.');
            }
        }

        async function fetchDataFromGoogleSheets() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values || [];
        }

        async function checkForNewData() {
            const data = await fetchDataFromGoogleSheets();
            if (data.length > lastRowCount) {
                lastRowCount = data.length;
                // Notify about new data
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'scheduleNotification',
                        delay: 0  // Send immediately
                    });
                }
            }
        }

        function startCheckingForNewData() {
            setInterval(checkForNewData, 30000); // Check every 30 seconds
        }

        document.getElementById('subscribeButton').addEventListener('click', subscribeToPushNotifications);

        // Start checking for new data when the page loads
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(startCheckingForNewData);
        }
    </script>
</body>
</html>
